---
title: "DecisionCurve Tutorial"
author: "Marshall Brown"
date: "September 6, 2015"
output: 
  html_document: 
    theme: cerulean
---

## Install the package 

You may navigate to the source package and use 


```{r, eval = FALSE}
install.packages("DecisionCurve_0.1.tar.gz", repos = NULL, type = "source")
```

 or install the package directly from github. 
 
```{r, eval = FALSE}
## install.packages("devtools")
library(devtools)
install_github("mdbrown/DecisionCurve")
```

## Getting started 

Load the package and the provided simulated data set. 

```{r}
library(DecisionCurve, quietly = TRUE)

#helper function
expit <- function(xx) exp(xx)/ (1+exp(xx))

#load simulated data 
data(dcaData)

head(dcaData)

# Assume we have access to previously published models 
# (or models built using a training set)
# that we can use to predict the risk of cancer. 

# Basic model using demographic variables: Age, Female, Smokes. 
dcaData$BasicModel <- with(dcaData, expit(-7.3 + 0.18*Age - 0.08*Female + 0.80*Smokes ) )

# Model using demographic + markers : Age, Female, Smokes, Marker1 and Marker2. 
dcaData$FullModel <- with(dcaData, expit(-10.5 + 0.22*Age  - 0.01*Female + 0.91*Smokes + 2.03*Marker1 - 1.56*Marker2))

#use DecisionCurve defaults (set bootstraps = 25 here to reduce computation time). 
DecisionCurve(dcaData,
              outcome = "Cancer", predictors = c("BasicModel", "FullModel"), 
              bootstraps = 25)

#see all available options using 
?DecisionCurve
```

## Tweaking the defaults 

Fine tune the thresholds, move the legend, and change linewidth and colors. Here we are calculating many more points on the curve (see the 'thresholds' setting).
```{r}
DecisionCurve(dcaData,
              outcome = "Cancer", predictors = c("BasicModel", "FullModel"), 
              thresholds = seq(0, .4, by = .001), # calculate thresholds from 0-0.4 at every 0.001 increment. 
              bootstraps = 25, 
              legend.position = "bottomleft",  #lwd and col correspond to order in predictors 
              lwd = c(3, 2),
              col = c("red", "blue"))

```

No confidence intervals, cost:benefit ratio axis, or legend

```{r}
DecisionCurve(dcaData,
              outcome = "Cancer", predictors = c("BasicModel", "FullModel"), 
              thresholds = seq(0, .4, by = .01), 
              bootstraps = 25, 
              legend.position = "none", lty = c(2, 1),
              confidence.intervals = "none", 
              cost.benefit.axis = FALSE, 
              ylim = c(-.1, 1))
```

 Set specific cost:benefit ratios. 

```{r}
DecisionCurve(dcaData,
              outcome = "Cancer", predictors = c("BasicModel", "FullModel"), 
              thresholds = seq(0, .4, by = .01), 
              bootstraps = 25, 
              legend.position = "bottomleft", lty = c(2, 1),
              cost.benefits = c("1:1000", "1:4", "1:9", "2:3", "1:3"))

```

Plot net benefit instead of standardize net benefit, change confidence interval level.

```{r}
DecisionCurve(dcaData,
              outcome = "Cancer", predictors = c("BasicModel", "FullModel"), 
              thresholds = seq(0, .4, by = .01), 
              bootstraps = 25, lty = c(2, 1),
              legend.position = "bottomleft", 
              standardize = FALSE,         #don't standardize the net benefit
              confidence.intervals = 0.90) #90% pointwise CI's
```

Add your own legend.

```{r}
#plot the curve with legend.postion = "none"
DecisionCurve(dcaData,
              outcome = "Cancer", predictors = c("BasicModel", "FullModel"), 
              thresholds = seq(0, .4, by = .01), 
              bootstraps = 25, 
              lty = c(2,1), 
              lwd = c(2, 2, 2, 2), 
              col = c("red", "blue", "grey66","black"), 
              legend.position = "none") 

#add your own legend. 
legend("bottomleft", 
       lwd = 2, lty = c(2, 1, 1, 1), 
       col = c("red", "blue", "grey66", "black"), 
       legend = c("Demographic model", "Demographic model +\n biomarkers", "Treat all", "Treat none"), 
       cex = .8 )

```

# Printing estimates 

DecisionCurve also outputs all calculations and point estimates when assigned to an object. 

```{r}
my.dc <- DecisionCurve(dcaData,
                       outcome = "Cancer", predictors = c("BasicModel", "FullModel"), 
                       thresholds = seq(0, 0.4, by = 0.05), 
                       bootstraps = 25, 
                       plot = FALSE) #don't plot curves. 
```

The best way to look at point estimates (w/ci's) is to use `summary`. 

```{r}
summary(my.dc)
```

You can also access the data directly. `my.dc$plot.data` holds the (standardized) net benefits for each predictor in wide form. 

```{r}
head(my.dc$plot.data$estimates)
head(my.dc$plot.data$ci_lower) #same for 'ci_upper' 
```

Alternatively, `my.dc$derived.data` give acess to all components of the net benefit calculations. It shows data for each predictor in long form (and therefore is great for using with `ggplot2`). 

```{r}
head(my.dc$derived.data)
```


# ggplot2 
Unfortunately, ggplot2 doesn't allow for multiple axis to be printed, so we are unable to plot the cost:benefit ratio axis. 

```{r}
library(ggplot2)

my.dc <- DecisionCurve(dcaData,
              outcome = "Cancer", predictors = c("BasicModel", "FullModel"), 
              thresholds = seq(0, .4, by = .001), #
              bootstraps = 25, 
              plot = FALSE)

ggdat <- my.dc$derived.data

#we need to remove the confidence intervals calculated for "all", since they aren't of interest. 
ggdat[ggdat$predictor == "all", "sNB_upper"] <- NA
ggdat[ggdat$predictor == "all", "sNB_lower"] <- NA


ggplot(ggdat,
       aes(threshold, sNB, 
           ymax = sNB_upper, 
           ymin = sNB_lower, 
           group = predictor, color = predictor, fill = predictor)) +  
  geom_ribbon(alpha = .2, color = "NA" ) +
  geom_line(size = 1.2) + 
  coord_cartesian(ylim = c(-0.2, 1), xlim = c(0, 0.4)) + 
  scale_color_manual(labels = c("all", "BasicModel", "FullModel", "none"),
                     values =  c( "grey66","red", "blue",  "black")) + 
  scale_fill_manual(labels = c("all", "BasicModel", "FullModel", "none"),
                    values =  c( "grey66","red", "blue", "black")) + 
  theme_bw() + theme(text = element_text(size = 18))


```







