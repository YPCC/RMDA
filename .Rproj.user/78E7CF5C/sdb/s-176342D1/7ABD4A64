{
    "contents" : "library(DecisionCurve)\nlibrary(wakefield)\n\nn = 100000\n\ndcaData <-\n  r_data_frame(\n  n = n,\n  age,\n  dummy(prob = c(.46, .54), name = \"Female\"),\n  smokes,\n  Marker1 = runif,\n  Marker2 = rnorm\n)\n\n\nattach(dcaData)\nlp <-   -10 +  log(1.25)*Age + log(.75)*Female + log(2)*Smokes + log(3)*Marker1 + log(.2)*Marker2\ndetach(dcaData)\n\n\nexpit <- function(xx) exp(xx)/ (1+exp(xx))\nlogit <- function(xx) log(xx/(1-xx))\n\ndcaData$truth = expit(lp)\n\n\ndcaData$Cancer <- rbinom(n, size =1 , prob = expit(lp))\n\nall.ind <- 1:n\ncc.ind  <- c(sample(all.ind[dcaData$Cancer == 1], size = 5000),\n             sample(all.ind[dcaData$Cancer ==0], size = 5000))\ndcaData_cc <- dcaData[cc.ind, ]\n\ncohort.glm <- glm(Cancer~Age + Female + Smokes + Marker1 + Marker2, data = dcaData, family = binomial())\n\nrho <- mean(dcaData$Cancer)\nobs.rho = mean(dcaData_cc$Cancer)\n\ncc.glm <- glm(Cancer~Age + Female + Smokes + Marker1 + Marker2, data = dcaData_cc, family = binomial(),\n              offset =  -rep(log((rho)/ (1-rho)) + log((obs.rho)/(1-obs.rho)), nrow(dcaData_cc)))\n\ndcaData_cc$myoff <- -log((rho)/ (1-rho)) + log((obs.rho)/(1-obs.rho))\ncc.glm2 <- glm(Cancer~Age + Female + Smokes + Marker1 + Marker2 ,\n               data = dcaData_cc,\n              family = binomial())\n\n\ntrue.coefs <- c(-10, log(1.25), log(.75), log(2), log(3), log(.2))\n\n\nrbind(coef(cohort.glm), coef(cc.glm), true.coefs)\n\n\nfull.model_cc <- decision_curve(Cancer~Age + Female + Smokes + Marker1 + Marker2,\n                                data = dcaData_cc,\n                                thresholds = seq(0, .4, by = .01),\n                                confidence.intervals = 'none',\n                                study.design = \"case-control\",\n                                population.prevalence =rho)\n\nfull.model_apparent <- decision_curve(Cancer~Age + Female + Smokes + Marker1 + Marker2,\n                                      data = dcaData,\n                                      confidence.intervals = 'none',\n                                      thresholds = seq(0, .4, by = .01))\n\nplot_decision_curve( list(full.model_apparent, full.model_cc, full.model_true),\n                     curve.names = c(\"cohort curve\", \"case-control curve\", \"truth\"),\n                     col = c(\"red\", \"blue\", \"magenta\"),\n                     lty = c(2,1, 1),\n                     lwd = c(3,2, 2,2, 1),\n                     legend.position = \"bottomright\")\n\nhead(full.model_apparent$derived.data)\nhead(full.model_cc$derived.data)\n\nplot(full.model_cc$derived.data$prob.high.risk, full.model_apparent$derived.data$prob.high.risk)\nabline(0,1)\n\nlibrary(pROC)\n\ncohort.roc <- roc(response = dcaData$Cancer, predictor = fitted(glm(Cancer~Age + Female + Smokes + Marker1 + Marker2,\n                                                                data = dcaData, family = binomial())))\n\ncc.roc <- roc(response = dcaData_cc$Cancer, predictor = fitted(glm(Cancer~Age + Female + Smokes + Marker1 + Marker2,\n                                                                    data = dcaData_cc, family = binomial())))\n\n#######\n####\n\n\n\nfull.model_cv <- cv_decision_curve(Cancer~Age + Female + Smokes+ Marker1 + Marker2,\n                                   data = dcaData,\n                                   folds = 5,\n                                   thresholds = seq(0, .4, by = .01))\n\nfull.model_apparent <- decision_curve(Cancer~Age + Female + Smokes + Marker1 + Marker2,\n                                      data = dcaData,\n                                      thresholds = seq(0, .4, by = .01),\n                                      confidence.intervals = 'none')\n\nfull.model_true <- decision_curve(Cancer~truth,\n                                  data = dcaData,\n                                  fitted.risk = TRUE,\n                                  thresholds = seq(0, .4, by = .01),\n                                  confidence.intervals = 'none')\n\n\nplot_decision_curve( list(full.model_apparent, full.model_cv, full.model_true),\n                     curve.names = c(\"Apparent curve\", \"Cross-validated curve\", \"True curve\"),\n                     col = c(\"red\", \"blue\", \"magenta\"),\n                     lty = c(2,1, 1),\n                     lwd = c(3,2, 2, 2, 1),\n                     legend.position = \"bottomright\")\n\n### check with dca.r\nsource(\"../decisioncurveanalysis/dca.r\")\n\n\ndcaData$model <- predict(cohort.glm, type = \"response\")\ndca.coh <- dca(data=data.frame(dcaData), outcome=\"Cancer\", predictors=\"model\", xstop=0.4)\n\nall.equal(dca.coh$net.benefit$model, full.model_apparent$derived.data$NB[2:41])\n\n\ny <- predict(cc.glm) - log((rho)/ (1-rho)) + log((obs.rho)/(1-obs.rho))\ndcaData_cc$model  <- exp(y)/(exp(y)+1)\n\ndca.cc <- dca(data=data.frame(dcaData_cc), outcome = \"Cancer\", predictors = \"model\", xstop = 0.4, ymin = -0.05)\n\nall.equal(dca.cc$net.benefit$model, full.model_cc$derived.data$NB[2:41])\nall.equal(dca.cc$net.benefit$model, full.model_apparent$derived.data$NB[2:41])\n\ncbind(dca.cc$net.benefit$model, full.model_cc$derived.data$NB[2:41])\n",
    "created" : 1452638687773.000,
    "dirty" : false,
    "encoding" : "UTF-8",
    "folds" : "",
    "hash" : "2581165473",
    "id" : "7ABD4A64",
    "lastKnownWriteTime" : 1452653426,
    "path" : "~/DecisionCurve-All/For-Manuscript/check-CaseControl.R",
    "project_path" : null,
    "properties" : {
    },
    "relative_order" : 2,
    "source_on_save" : false,
    "type" : "r_source"
}